import React, { useState } from "react";
import { View, Text, TextInput, TouchableOpacity, Alert } from "react-native";
import { createSensor, updateSensor } from "../services/api";
import Loader from "../components/Loader";

export default function SensorFormScreen({ route, navigation }) {
  const editing = !!route.params?.sensor;
  const [nome, setNome] = useState(route.params?.sensor?.nome || "");
  const [status, setStatus] = useState(route.params?.sensor?.status || "");
  const [localizacao, setLocalizacao] = useState(route.params?.sensor?.localizacao || "");
  const [loading, setLoading] = useState(false);

  async function handleSave() {
    if (!nome || !status || !localizacao) {
      Alert.alert("Preencha todos os campos!");
      return;
    }
    setLoading(true);
    try {
      if (editing) {
        await updateSensor(route.params.sensor.id, { nome, status, localizacao });
      } else {
        await createSensor({ nome, status, localizacao });
      }
      navigation.goBack();
    } catch (e) {
      Alert.alert("Erro ao salvar.");
    } finally {
      setLoading(false);
    }
  }

  if (loading) return <Loader />;

  return (
    <View className="flex-1 bg-white p-6">
      <Text className="text-2xl font-bold mb-6">
        {editing ? "Editar Sensor" : "Novo Sensor"}
      </Text>
      <TextInput
        className="border-b border-gray-300 mb-6 py-2"
        placeholder="Nome"
        value={nome}
        onChangeText={setNome}
      />
      <TextInput
        className="border-b border-gray-300 mb-6 py-2"
        placeholder="Status"
        value={status}
        onChangeText={setStatus}
      />
      <TextInput
        className="border-b border-gray-300 mb-8 py-2"
        placeholder="Localização"
        value={localizacao}
        onChangeText={setLocalizacao}
      />
      <TouchableOpacity
        className="bg-blue-700 py-3 rounded-xl items-center"
        onPress={handleSave}
      >
        <Text className="text-white font-bold text-lg">
          {editing ? "Salvar Alterações" : "Cadastrar"}
        </Text>
      </TouchableOpacity>
    </View>
  );
}
